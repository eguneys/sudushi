var Space=function(){"use strict";const t={equals:(t,e)=>t===e};let e=w;const r={},n={owned:null,cleanups:null,context:null,owner:null};c(!1);var i=null;let s=null,o=null,l=null,a=null,u=0;function h(t){const e=s,r=i,o=0===t.length?n:{owned:null,cleanups:null,context:null,owner:r};i=o,s=null;try{return m((()=>t((()=>E(o)))),!0)}finally{s=e,i=r}}function c(e,n){n=n?Object.assign({},t,n):t;const i={value:e,observers:null,observerSlots:null,pending:r,comparator:n.equals||void 0};return[_.bind(i),t=>("function"==typeof t&&(t=t(i.pending!==r?i.pending:i.value)),A(i,t))]}function d(t,e,r){v(p(t,e,!1,1))}function g(t,r,n){e=P;const i=p(t,r,!1,1);i.user=!0,a?a.push(i):queueMicrotask((()=>v(i)))}function f(e,n,i){i=i?Object.assign({},t,i):t;const s=p(e,n,!0,0);return s.pending=r,s.observers=null,s.comparator=i.equals||void 0,v(s),_.bind(s)}function _(){if(this.sources&&this.state){const t=l;l=null,1===this.state?v(this):b(this),l=t}if(s){const t=this.observers?this.observers.length:0;s.sources?(s.sources.push(this),s.sourceSlots.push(t)):(s.sources=[this],s.sourceSlots=[t]),this.observers?(this.observers.push(s),this.observerSlots.push(s.sources.length-1)):(this.observers=[s],this.observerSlots=[s.sources.length-1])}return this.value}function A(t,e,n){return o?(t.pending===r&&o.push(t),t.pending=e,e):(t.comparator&&t.comparator(t.value,e)||(t.value=e,t.observers&&t.observers.length&&m((()=>{for(let e=0;e<t.observers.length;e+=1){const r=t.observers[e];r.state||(r.pure?l.push(r):a.push(r),r.observers&&D(r)),r.state=1}if(l.length>1e6)throw l=[],new Error}),!1)),e)}function v(t){if(!t.fn)return;E(t);const e=i,r=s,n=u;s=i=t,function(t,e,r){let n;try{n=t.fn(e)}catch(t){T(t)}(!t.updatedAt||t.updatedAt<=r)&&(t.observers&&t.observers.length?A(t,n):t.value=n,t.updatedAt=r)}(t,t.value,n),s=r,i=e}function p(t,e,r,s=1,o){const l={fn:t,state:s,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:e,owner:i,context:null,pure:r};return null===i||i!==n&&(i.owned?i.owned.push(l):i.owned=[l]),l}function m(t,r){if(l)return t();let n=!1;r||(l=[]),a?n=!0:a=[],u++;try{return t()}catch(t){T(t)}finally{!function(t){l&&(w(l),l=null);if(t)return;a.length?x((()=>{e(a),a=null})):a=null}(n)}}function x(t){if(o)return t();let e;const n=o=[];try{e=t()}finally{o=null}return m((()=>{for(let t=0;t<n.length;t+=1){const e=n[t];if(e.pending!==r){const t=e.pending;e.pending=r,A(e,t)}}}),!1),e}function y(t){if(0===t.state)return;if(2===t.state)return b(t);const e=[t];for(;(t=t.owner)&&(!t.updatedAt||t.updatedAt<u);)t.state&&e.push(t);for(let r=e.length-1;r>=0;r--)if(1===(t=e[r]).state)v(t);else if(2===t.state){const r=l;b(t,e[0]),l=r}}function w(t){for(let e=0;e<t.length;e++)y(t[e])}function b(t,e){t.state=0;for(let r=0;r<t.sources.length;r+=1){const n=t.sources[r];n.sources&&(1===n.state?n!==e&&y(n):2===n.state&&b(n,e))}}function E(t){let e;if(t.sources)for(;t.sources.length;){const e=t.sources.pop(),r=t.sourceSlots.pop(),n=e.observers;if(n&&n.length){const t=n.pop(),i=e.observerSlots.pop();r<n.length&&(t.sourceSlots[i]=r,n[r]=t,e.observerSlots[r]=i)}}if(t.owned){for(e=0;e<t.owned.length;e++)E(t.owned[e]);t.owned=null}if(t.cleanups){for(e=0;e<t.cleanups.length;e++)t.cleanups[e]();t.cleanups=null}t.state=0,t.context=null}function T(t){throw t}function R(t){let e;return void 0!==(e=S(i,t.id))?e:t.defaultValue}function S(t,e){return t?t.context&&void 0!==t.context[e]?t.context[e]:S(t.owner,e):void 0}function M(t){return function(e){let r;var n,s;return n=()=>r=k((()=>(i.context={[t]:e.value},function(t){const e=f(t);return f((()=>U(e())))}((()=>e.children))))),v(p(n,s,!0,void 0)),r}}function U(t){if("function"==typeof t&&!t.length)return U(t());if(Array.isArray(t)){const e=[];for(let r=0;r<t.length;r++){const n=U(t[r]);Array.isArray(n)?e.push.apply(e,n):e.push(n)}return e}return t}function k(t){let e,r=s;return s=null,e=t(),s=r,e}function P(t){let e,r=0;for(e=0;e<t.length;e++){const n=t[e];n.user?t[r++]=n:y(n)}const n=t.length;for(e=0;e<r;e++)y(t[e]);for(e=n;e<t.length;e++)y(t[e])}function I(t,e,r){const n=Array.isArray(t);let i;return s=>{let o,l=r&&r.defer;if(n){o=[];for(let e=0;e<t.length;e++)o.push(t[e]())}else o=t();if(l)return void(l=!1);const a=k((()=>e(o,i,s)));return i=o,a}}function D(t){for(let e=0;e<t.observers.length;e+=1){const r=t.observers[e];r.state||(r.state=2,r.pure?l.push(r):a.push(r),r.observers&&D(r))}}function F(t){for(let e=0;e<t.length;e++)t[e]()}function $(t,e,r={}){let n=[],s=[],o=[],l=0,a=e.length>1?[]:null;var u;return u=()=>F(o),null===i||(null===i.cleanups?i.cleanups=[u]:i.cleanups.push(u)),()=>{let i,u,d=t()||[];return k((()=>{let t,e,c,f,_,A,v,p,m,x=d.length;if(0===x)0!==l&&(F(o),o=[],n=[],s=[],l=0,a&&(a=[])),r.fallback;else if(0===l){for(s=new Array(x),u=0;u<x;u++)n[u]=d[u],s[u]=h(g);l=x}else{for(c=new Array(x),f=new Array(x),a&&(_=new Array(x)),A=0,v=Math.min(l,x);A<v&&n[A]===d[A];A++);for(v=l-1,p=x-1;v>=A&&p>=A&&n[v]===d[p];v--,p--)c[p]=s[v],f[p]=o[v],a&&(_[p]=a[v]);for(t=new Map,e=new Array(p+1),u=p;u>=A;u--)m=d[u],i=t.get(m),e[u]=void 0===i?-1:i,t.set(m,u);for(i=A;i<=v;i++)m=n[i],u=t.get(m),void 0!==u&&-1!==u?(c[u]=s[i],f[u]=o[i],a&&(_[u]=a[i]),u=e[u],t.set(m,u)):o[i]();for(u=A;u<x;u++)u in c?(s[u]=c[u],o[u]=f[u],a&&(a[u]=_[u],a[u](u))):s[u]=h(g);s=s.slice(0,l=x),n=d.slice(0)}return s}));function g(t){if(o[u]=t,a){const[t,r]=c(u);return a[u]=r,e(d[u],t)}return e(d[u])}}}function L(t,e){return k((()=>t(e)))}function B(t){return f($((()=>t.each),t.children))}class C{constructor(t,e,r){this.$wrap=t,this.width=e,this.height=r,this.$canvas=document.createElement("canvas"),this.$canvas.width=e,this.$canvas.height=r,t.appendChild(this.$canvas);let n=this.$canvas.getContext("webgl2",{alpha:!0,antialias:!1});null!==n&&(this.gl=n),this.$canvas.addEventListener("webglcontextlost",(t=>{console.log("context lost"),t.preventDefault(),this.gl=void 0})),this.$canvas.addEventListener("webglcontextrestored",(()=>{console.log("restored"),null!==n&&(this.gl=n)}))}}class j{constructor(t,e,r){this.uniformData=t,this.attributeData=e,this.program=r}}function q(t,e,r){const n=N(t,t.VERTEX_SHADER,e),i=N(t,t.FRAGMENT_SHADER,r),s=t.createProgram();t.attachShader(s,n),t.attachShader(s,i),t.linkProgram(s),t.getProgramParameter(s,t.LINK_STATUS)||function(t,e,r,n){t.getProgramParameter(e,t.LINK_STATUS)||(t.getShaderParameter(r,t.COMPILE_STATUS)||z(t,r),t.getShaderParameter(n,t.COMPILE_STATUS)||z(t,n),console.error("Iksir: Couldn't initialize shader"),""!==t.getProgramInfoLog(e)&&console.warn("Iksir: gl.getProgramInfoLog()",t.getProgramInfoLog(e)))}(t,s,n,i);let o=function(t,e){const r={},n=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES);for(let i=0;i<n;i++){const n=t.getActiveAttrib(e,i);if(0===n.name.indexOf("gl_"))continue;const s={tpe:"tpe",name:n.name,size:0,location:i};r[n.name]=s}return r}(t,s),l=function(t,e){const r={},n=t.getProgramParameter(e,t.ACTIVE_UNIFORMS);for(let i=0;i<n;i++){const n=t.getActiveUniform(e,i),s={name:n.name,location:-1,index:i};r[n.name]=s}return r}(t,s);const a=Object.keys(o);for(let e=0;e<a.length;e++)o[a[e]].location=e,t.bindAttribLocation(s,e,a[e]);t.linkProgram(s),t.deleteShader(n),t.deleteShader(i);for(let e in l)l[e],l[e].location=t.getUniformLocation(s,e);return new j(l,o,s)}function N(t,e,r){const n=t.createShader(e);return t.shaderSource(n,r),t.compileShader(n),n}function z(t,e){const r=t.getShaderSource(e).split("\n").map(((t,e)=>`${e}: ${t}`)),n=t.getShaderInfoLog(e),i=n.split("\n"),s={},o=i.map((t=>parseFloat(t.replace(/^ERROR\: 0\:([\d]+)\:.*$/,"$1")))).filter((t=>!(!t||s[t])&&(s[t]=!0,!0))),l=[""];o.forEach((t=>{r[t-1]=`%c${r[t-1]}%c`,l.push("background: #FF0000; color:#FFFFFF; font-size: 10px","font-size: 10px")}));const a=r.join("\n");l[0]=a,console.error(n),console.groupCollapsed("click to view full shader code"),console.warn(...l),console.groupEnd()}class O{constructor(t,e){this.quad=t,this.tint=e}}class X{get _flat(){return this.__flat||(this.__flat=[this,...this._children.flatMap((t=>t._flat))]),this.__flat}constructor(t=[],e=V.unit,r=V.unit){this._children=t,this.world=e,this._local=r}get quad(){return this.textint?.quad}get tint(){return this._tint}set quad(t){this.textint=new O(t,this._tint)}_tint=16777215;set tint(t){this._tint=t,this.textint&&(this.textint.tint=t)}size=G.unit;pivot=G.zero;scale=G.unit;rotation=0;translate=G.zero;get clone(){let t=new X([],this.world.clone,this._local.clone);return this._children.forEach((e=>e.clone._set_parent(t))),t.size=this.size.clone,t.pivot=this.pivot.clone,t.scale=this.scale.clone,t.rotation=this.rotation,t.translate=this.translate.clone,t.quad=this.quad,t.tint=this.tint,t._dirty_upto_parent(),t._update_world(),t}get local(){let{size:t,scale:e,rotation:r,translate:n,pivot:i}=this,s=e.mul(t);return this._local.transform_in(s,r,n,i),this._local}get x(){return this.translate.x}set x(t){this.translate.set_in(t,this.y)}get y(){return this.translate.y}set y(t){this.translate.set_in(this.x,t)}_dirty_upto_parent(){let t=this;do{t.__flat=void 0}while(t=t._parent)}_clean_children(){this._children.forEach((t=>t.parent=void 0)),this._children.splice(0),this._dirty_upto_parent()}_set_parent(t){t._children.push(this),this._parent=t,this._dirty_upto_parent()}get _next_sibling(){return this._parent._children[this._parent._children.indexOf(this)+1]}get _first_child(){return this._children[0]}_insert_before(t,e){if(t===e)return;t._remove();let r=this._children.indexOf(e);-1===r&&(r=this._children.length),this._children.splice(r,0,t),t._parent=this,t._dirty_upto_parent()}_replace_child(t,e){t._remove(),this._children.splice(this._children.indexOf(e),1,t),e._parent=void 0,t._parent=this,t._dirty_upto_parent()}_remove(){this._parent&&(this._parent._children.splice(this._parent._children.indexOf(this),1),this._parent._dirty_upto_parent(),this._parent=void 0)}_update_world(t){t?(this.world.set_in(t),this.world.mul_in(this.local)):this.world.set_in(this.local);let{world:e}=this;this._children.forEach((t=>t._update_world(e)))}}class G{static from_angle=t=>new G(Math.cos(t),Math.sin(t));static make=(t,e)=>new G(t,e);static get unit(){return new G(1,1)}static get zero(){return new G(0,0)}get vs(){return[this.x,this.y]}get mul_inverse(){return new G(1/this.x,1/this.y)}get add_inverse(){return new G(-this.x,-this.y)}get half(){return new G(this.x/2,this.y/2)}get length(){return Math.sqrt(this.x*this.x+this.y*this.y)}get normalize(){return 0===this.length?G.zero:this.scale(1/this.length)}get clone(){return new G(this.x,this.y)}get angle(){return Math.atan2(this.y,this.x)}constructor(t,e){this.x=t,this.y=e}distance(t){return this.sub(t).length}addy(t){return G.make(this.x,this.y+t)}add_angle(t){return G.from_angle(this.angle+t)}scale(t){return G.make(this.x*t,this.y*t)}add(t){let{clone:e}=this;return e.add_in(t),e}add_in(t){this.x+=t.x,this.y+=t.y}sub(t){let{clone:e}=this;return e.sub_in(t),e}sub_in(t){this.x-=t.x,this.y-=t.y}mul(t){let{clone:e}=this;return e.mul_in(t),e}mul_in(t){this.x*=t.x,this.y*=t.y}div(t){let{clone:e}=this;return e.div_in(t),e}div_in(t){this.x/=t.x,this.y/=t.y}set_in(t,e=t){this.x=t,this.y=e}}class Y{static make=(t,e,r,n)=>new Y([G.make(t,e),G.make(t+r,e),G.make(t+r,e+n),G.make(t,e+n)]);static get unit(){return Y.make(0,0,1,1)}get vs(){let{x:t,y:e,w:r,h:n}=this;return[t,e,r,n]}get x1(){return this.vertices[0].x}get y1(){return this.vertices[0].y}get x2(){return this.vertices[2].x}get y2(){return this.vertices[2].y}get x(){return this.x1}get y(){return this.y1}get w(){return this.x2-this.x1}get h(){return this.y2-this.y1}get vertexData(){return new Float32Array(this.vertices.flatMap((t=>t.vs)))}get indices(){return new Uint16Array([0,1,2,0,2,3])}constructor(t){this.vertices=t}transform(t){return new Y(this.vertices.map((e=>t.mVec2(e))))}}class V{static get identity(){return new V(1,0,0,1,0,0)}static get unit(){return V.identity}static projection=(t,e)=>new V(1/t*2,0,0,-1/e*2,-1,1);get clone(){let{a:t,b:e,c:r,d:n,tx:i,ty:s}=this;return new V(t,e,r,n,i,s)}get inverse(){let{a:t,b:e,c:r,d:n,tx:i,ty:s}=this,o=t*n-e*r;return new V(n/o,-e/o,-r/o,t/o,(r*s-n*i)/o,-(t*s-e*i)/o)}constructor(t,e,r,n,i,s){this.a=t,this.b=e,this.c=r,this.d=n,this.tx=i,this.ty=s,this.array_t=new Float32Array([t,e,0,r,n,0,i,s,1])}rotate_in(t){let e=Math.cos(t),r=Math.sin(t),n=this.a*e-this.b*r,i=this.a*r+this.b*e,s=this.c*e-this.d*r,o=this.c*r+this.d*e,l=this.tx*e-this.ty*r,a=this.tx*r+this.ty*e;this.a=n,this.b=i,this.c=s,this.d=o,this.tx=l,this.ty=a}rotate(t){let{clone:e}=this;return e.rotate_in(t),e}scale(t,e){let r=this.a*t,n=this.b,i=this.c,s=this.d*e,o=this.tx,l=this.ty;return new V(r,n,i,s,o,l)}translate_in(t,e){this.a,this.b,this.c,this.d;let r=t+this.tx,n=e+this.ty;this.tx=r,this.ty=n}translate(t,e){let{clone:r}=this;return r.translate_in(t,e),r}scale_in(t,e){this.a=t,this.d=e}mVec2(t){let e=this.a,r=this.b,n=this.c,i=this.d,s=this.tx,o=this.ty,l=e*t.x+n*t.y+s,a=r*t.x+i*t.y+o;return G.make(l,a)}mul_in(t){let{a:e,b:r,c:n,d:i,tx:s,ty:o}=this;this.a=t.a*e+t.b*n,this.b=t.a*r+t.b*i,this.c=t.c*e+t.d*n,this.d=t.c*r+t.d*i,this.tx=t.tx*e+t.ty*n+s,this.ty=t.tx*r+t.ty*i+o}set_in(t){let{a:e,b:r,c:n,d:i,tx:s,ty:o}=t;this.a=e,this.b=r,this.c=n,this.d=i,this.tx=s,this.ty=o}transform_in(t,e,r,n=G.half){this.a=Math.cos(e)*t.x,this.b=Math.sin(e)*t.x,this.c=-Math.sin(e)*t.y,this.d=Math.cos(e)*t.y,this.tx=r.x-(n.x*this.a+n.y*this.c),this.ty=r.y-(n.x*this.b+n.y*this.d)}}function H(t){return[(16711680&t)>>16,(65280&t)>>8,255&t].map((t=>t/255))}class Q{get gl(){return this.canvas.gl}get width(){return this.canvas.width}get height(){return this.canvas.height}constructor(t){this.canvas=t,this.projectionMatrix=V.projection(this.width,this.height)}glOnce=(t={})=>{let{gl:e}=this;if(!e)return;let{color:r}=t;e.viewport(0,0,this.width,this.height),e.clearColor(...H(r||0),1),e.enable(e.BLEND),e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA)};glProgram=(t,e,r)=>{let{gl:n}=this,{program:i,uniformData:s,attributeData:o}=q(n,t,e),l=n.createVertexArray();n.bindVertexArray(l);let a=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,a),n.bufferData(n.ARRAY_BUFFER,6*r*4,n.DYNAMIC_DRAW);let u=n.createBuffer();n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,u),n.bufferData(n.ELEMENT_ARRAY_BUFFER,3*r*4,n.DYNAMIC_DRAW);let h=o.aVertexPosition.location;n.enableVertexAttribArray(h),n.vertexAttribPointer(h,2,n.FLOAT,!1,28,0);let c=o.aTextureCoord.location;n.enableVertexAttribArray(c),n.vertexAttribPointer(c,2,n.FLOAT,!1,28,8);let d=o.aTint.location;return n.enableVertexAttribArray(d),n.vertexAttribPointer(d,3,n.FLOAT,!1,28,16),n.bindVertexArray(null),{program:i,uniformData:s,indexBuffer:u,attributeBuffer:a,vao:l}};glTexture(){let{gl:t}=this,e=t.createTexture();return t.bindTexture(t.TEXTURE_2D,e),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,new Uint8Array([0,0,255,255])),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),{glTexture:e}}glUseTexture(t,e){let{gl:r}=this;r.bindTexture(r.TEXTURE_2D,t),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,e.width,e.height,0,r.RGBA,r.UNSIGNED_BYTE,e)}glUse(t,e){let{gl:r}=this;r.useProgram(t),r.uniformMatrix3fv(e.projectionMatrix.location,!1,this.projectionMatrix.array_t)}glUniformUpdate(t,e){}glAttribUpdate(t,e){let{gl:r}=this;r.bindBuffer(r.ARRAY_BUFFER,t),r.bufferSubData(r.ARRAY_BUFFER,0,e,0)}glIndexUpdate(t,e){let{gl:r}=this;r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,t),r.bufferSubData(r.ELEMENT_ARRAY_BUFFER,0,e,0)}glClear(){let{gl:t}=this;t.clear(t.COLOR_BUFFER_BIT)}glDraw(t,e){let{gl:r}=this;r.bindVertexArray(e),r.drawElements(r.TRIANGLES,t,r.UNSIGNED_SHORT,0)}}class W{static make=(t,e,r,n=t.width,i=t.height)=>new W(t,Y.make(e,r,n,i));get w(){return this._frame.w}get h(){return this._frame.h}get x0(){return this.frame.x}get y0(){return this.frame.y}get x1(){return this.frame.x2}get y1(){return this.y0}get x2(){return this.x1}get y2(){return this.frame.y2}get x3(){return this.x0}get y3(){return this.y2}constructor(t,e){this.texture=t,this._frame=e,this.tw=t.width,this.th=t.height,this.frame=e.transform(V.unit.scale(1/this.tw,1/this.th)),this.fsUv=new Float32Array([this.x0,this.y0,this.x1,this.y1,this.x2,this.y2,this.x3,this.y3])}}function J(t,e){return new X}function Z(t,e,r){t[e]=null==r?void 0:r}function K(t,e,r,n){if(void 0===r||n||(n=[]),"function"!=typeof e)return tt(t,e,n,r);d((n=>tt(t,e(),n,r)),n)}function tt(t,e,r,n,i){for(;"function"==typeof r;)r=r();if(e===r)return r;const s=typeof e,o=void 0!==n;if(t=o&&r[0]&&r[0]._parent||t,null==e)r=nt(t,r,n);else{if("function"===s)return d((()=>{let i=e();for(;"function"==typeof i;)i=i();r=tt(t,i,r,n)})),()=>r;if(Array.isArray(e)){const s=[];if(et(s,e,i))return d((()=>r=tt(t,s,r,n,!0))),()=>r;if(0===s.length){if(r=nt(t,r,n),o)return r}else Array.isArray(r)?0===r.length?rt(t,s):function(t,e,r){let n=r.length,i=e.length,s=n,o=0,l=0,a=e[i-1]._next_sibling,u=null;for(;o<i||l<s;)if(e[o]!==r[l]){for(;e[i-1]===r[s-1];)i--,s--;if(i===o){const e=s<n?l?r[l-1]._next_sibling:r[s-l]:a;for(;l<s;)t._insert_before(r[l++],e)}else if(s===l)for(;o<i;)u&&u.has(e[o])||e[o]._remove(),o++;else if(e[o]===r[s-1]&&r[l]===e[i-1]){const n=e[--i]._next_sibling;t._insert_before(r[l++],e[o++]._next_sibling),t._insert_before(r[--s],n),e[i]=r[s]}else{if(!u){u=new Map;let t=l;for(;t<s;)u.set(r[t],t++)}const n=u.get(e[o]);if(null!=n)if(l<n&&n<s){let a,h=o,c=1;for(;++h<i&&h<s&&null!=(a=u.get(e[h]))&&a===n+c;)c++;if(c>n-l){const i=e[o];for(;l<n;)t._insert_before(r[l++],i)}else t._replace_child(r[l++],e[o++])}else o++;else e[o++]._remove()}}else o++,l++}(t,r,s):(r&&nt(t),rt(t,s));r=s}else if(e instanceof X){if(Array.isArray(r)){if(o)return r=nt(t,r,n,e);nt(t,r,null,e)}else null!==r&&t._first_child?t._replace_child(e,t._first_child):e._set_parent(t);r=e}}return r}function et(t,e,r){let n=!1;for(let i=0,s=e.length;i<s;i++){let s=e[i];if(s instanceof X)t.push(s);else if(null==s||!0===s||!1===s);else if(Array.isArray(s))n=et(t,s)||n;else if("function"==typeof s)if(r){for(;"function"==typeof s;)s=s();n=et(t,Array.isArray(s)?s:[s])||n}else t.push(s),n=!0}return n}function rt(t,e,r){for(let r=0,n=e.length;r<n;r++)e[r]._set_parent(t)}function nt(t,e,r,n){if(void 0===r)return t._clean_children()&&t._children;const i=n||[];if(e.length){let n=!1;for(let s=e.length-1;s>=0;s--){const o=e[s];if(i!==o){const e=o._parent===t;n||s?e&&o._remove():e?t._replace_child(i,o):t._insert_before(i,r)}else n=!0}}else t._insert_before(i,r);return[i]}const it=1e3/60,st={seconds:60*it,half:30*it,thirds:20*it,lengths:15*it,sixth:10*it,five:5*it,three:50,one:1*it};class ot{_wheel=0;_wheel0=0;get bounds(){return this._bounds||(this._bounds=this.$canvas.getBoundingClientRect()),this._bounds}get wheel(){return this._wheel}get drag(){if(this._drag?.move)return this._drag}get click(){if(!this._drag?.move&&this._drag?.drop)return this._drag.drop}get lclick(){if(0===this._drag?.button)return this.click}get rclick(){if(2===this._drag?.button)return this.click}get click_down(){if(!this._drag0&&this._drag&&!this._drag?.move&&!this._drag?.drop)return this._drag.start}get hover(){if(!this._drag)return this._hover}get drag_delta(){if(this._drag?.move)return[this._drag.move[0]-this._drag.start[0],this._drag.move[1]-this._drag.start[1]]}constructor(t){this.$canvas=t}eventPosition(t){let e=function(t){return void 0!==t.clientX&&void 0!==t.clientY?[t.clientX,t.clientY]:t.targetTouches?.[0]?[t.targetTouches[0].clientX,t.targetTouches[0].clientY]:void 0}(t),{bounds:r}=this,n=320/r.width,i=180/r.height;return e&&(e[0]-=r.left,e[1]-=r.top,e[0]*=n,e[1]*=i),e}disposes=[];dispose(){this.disposes.forEach((t=>t()))}init(){let{$canvas:t,disposes:e}=this;t.addEventListener("wheel",(t=>{this._wheel=Math.sign(t.deltaY)})),t.addEventListener("mousedown",(t=>{this._drag||(this._drag1={button:t.button,start:this.eventPosition(t)})})),t.addEventListener("mousemove",(t=>{this._drag?this._drag.r_move=this.eventPosition(t):this._hover=this.eventPosition(t)})),t.addEventListener("contextmenu",(t=>{t.preventDefault(),this._drag||(this._drag1={button:t.button,start:this.eventPosition(t)})}));let r=t=>{this._drag&&(this._drag.drop=this.eventPosition(t),this._drop0=this._drag)};document.addEventListener("mouseup",r),e.push((()=>document.removeEventListener("mouseup",r)));const n=()=>{this._bounds=void 0};return window.addEventListener("resize",n),document.addEventListener("scroll",n),e.push((()=>window.removeEventListener("resize",n))),e.push((()=>document.removeEventListener("scroll",n))),this}update(t,e){this._wheel0===this._wheel?this._wheel=0:this._wheel0=this._wheel,this._drag&&(this._drag.move0=this._drag.move,void 0!==this._drag.r_move&&(this._drag.move||function(t,e){let r=t[0]-e[0],n=t[1]-e[1];return Math.sqrt(r*r+n*n)>3}(this._drag.r_move,this._drag.start))&&(this._drag.move=this._drag.r_move),this._drop0?this._drop0=void 0:this._drag.drop&&(this._drag1=void 0)),this._drag0=this._drag,this._drag1!==this._drag&&(this._drag=this._drag1)}}const lt=function(t){const e=Symbol("context");return{id:e,Provider:M(e),defaultValue:t}}({}),at=t=>{const[e,r]=c(),[n,i]=c(),[s,o]=c([16,16],{equals:!1}),[l,a]=c(new ot(t.$canvas).init(),{equals:!1}),[u,h]=c(void 0,{equals:!1});let d=[{image:e,root:n,update:s,render:u,mouse:l},{_setImage:r,_setRoot:i}];return function(t){let e,r,n=1e3/60,i=n;e=requestAnimationFrame((function s(o){let l=r?o-r:n;l=Math.min(33.333333333333336,Math.max(16.666666666666668,l)),t(l,i),i=l,r=o,e=requestAnimationFrame(s)}))}(((t,e)=>{o([t,e]),a((r=>(r.update(t,e),r))),h()})),L(lt.Provider,{value:d,get children(){return t.children}})},ut=()=>R(lt);function ht(t,e){if("function"==typeof e)return t[1](e);t[1]((t=>e))}function ct(t,e){return t[1]((t=>(e(t),t)))}function dt(t){return Array.isArray(t)?t[0]():t()}const gt=(()=>{let t=0;return()=>++t})();function ft(t,e){return`${t} ${e} ${gt()}`}function _t(t){return t.split(" ").map((t=>parseFloat(t)))}const At=ft(0,0),vt=["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","!","0","1","2","3","4","5","6","7","8","9",",","."];function pt(t){return t.split("").map((t=>vt.indexOf(t)))}class mt{get enemies(){return this._enemies.values}get projectiles(){return this._projectiles.values}constructor(){this.cursor=function(){const[{mouse:t,update:e}]=ut();let r=yt(0,0),n=yt(0,0),i=yt(0,0);return g(I(e,(()=>{let{hover:e,lclick:s,rclick:o}=t();e&&x((()=>{r.x=e[0],r.y=e[1]})),s&&x((()=>{n.x=s[0],n.y=s[1]})),o&&x((()=>{i.x=o[0],i.y=o[1]}))}))),{pos:r,click:n,rclick:i}}(),this.player=function(t){let e=yt(100,100),r=yt(100,100),n=wt(100,1e3,.92),i=wt(100,1e3,.92),s=kt([],xt),o=f((()=>s.head));g((()=>{let t=o();t&&(r.x=t.pos.x,r.y=t.pos.y)}));let l=f((()=>r.m_vs().sub(e.m_vs()).normalize)),a=f((()=>e.m_vs().distance(r.m_vs()))),u=f((()=>a()<8));return g(I(u,(t=>{g(I(Tt(st.seconds),(()=>{g(I(Rt(st.half),(t=>{-1===t?(n.force=0,i.force=0):(n.force=.5*l().x,i.force=.5*l().y)})))})))}))),g((()=>{e.x=n.x,e.y=i.x})),g((()=>{let e=ft(...t.cursor.click.m_vs().vs);e!==At&&s.enqueue(e)})),g(I(t.cursor.rclick.m_vs,(()=>{s.clear()}))),{get direction(){return l()},get projectiles(){return guns.values},m_distance:a,m_reached:u,pos:e,target:r,get waypoints(){return s.values}}}(this),this._enemies=kt([],(t=>function(t,e,r){let[{update:n}]=ut(),i=yt(..._t(r)),s=wt(_t(r)[0],1e3,.92),o=wt(_t(r)[1],1e3,.92),l=f((()=>e.player.pos.m_vs().sub(i.m_vs()).normalize));g(I(Tt(st.seconds),(()=>{g(I(Rt(st.sixth),(t=>{x(-1===t?()=>{s.force=0,o.force=0}:()=>{s.force=.5*l().x,o.force=.5*l().y})})))}))),g(I(n,(()=>{i.x=s.x,i.y=o.x})));let a=St(st.half,4,0);return{pos:i,get tint(){return a()},take_hit(){t()}}}((t=>this._enemies.remove(t)),this,t))),this._projectiles=kt([],(e=>function(t,e,r){let n=yt(..._t(e)),i=wt(n.x,1e3,.92),s=wt(n.y,1e3,.92),o=function(t,e,r,n=Mt){let i=Et(),s=f((()=>Math.min(1,i()/r))),o=f((()=>n(s()))),l=f((()=>t*(1-o())+e*o()));return{get i(){return o()},get value(){return l()},m_i:o,m_value:l}}(1,0,st.seconds-st.thirds),l=G.make(..._t(r));return g(I(Rt(st.seconds),(e=>{-1===e?(i.force=0,s.force=0,t()):(i.force=l.x*o.value*2,s.force=l.y*o.value*2)}))),g((()=>{n.x=i.x,n.y=s.x})),{pos:n,hit(){}}}((()=>this._projectiles.remove(e)),t.pos.point,e))),this.level=function(t,e){let r=c(e),n=f((()=>"level "+Ut(dt(r))));return{get level_digit(){return dt(r)},up(){ht(r,(t=>Math.min(10,t+1)))},reset(){ht(r,0)},m_level:f($((()=>pt(n())),bt))}}(0,0),this.health=function(t,e){let r=c(e),n=f((()=>"health "+Ut(dt(r))));return{m_health:f($((()=>pt(n())),bt)),down(){ht(r,(t=>Math.max(0,t-1)))},max(){ht(r,Pt)},quarter(){ht(r,(t=>Math.min(Pt,t+2.5)))}}}(0,8),this.status=function(t){let e=c(""),r=f((()=>dt(e)));return{m_status:f($((()=>pt(r())),bt)),set status(t){ht(e,t)}}}(),this.status.status="click around to move";let{player:t,cursor:e}=this;const r=t=>{this._projectiles.push(t)};f((()=>{this.projectiles.map((t=>{this.enemies.forEach((e=>{var r,n;r=e.pos.m_vs(),n=t.pos.m_vs(),r.distance(n)<4&&(t.hit(e),e.take_hit(t))}))}))})),setInterval((()=>{for(let e=0;e<5;e++)setTimeout((()=>{let n=e/5*Math.PI*.05,i=t.direction.add_angle(n+Math.PI+Math.random()*Math.PI*.2);r(ft(i.x,i.y))}),e/5*100+100*Math.random())}),200),setInterval((()=>{for(let e=0;e<10;e++){let n=e/10*Math.PI*.1,i=t.direction.add_angle(n);r(ft(i.x,i.y))}}),800),setInterval((()=>{this._enemies.push(ft(320*Math.random(),180*Math.random()))}),940),setInterval((()=>{this.level.up()}),500),setInterval((()=>{this.level.reset()}),5e3),setInterval((()=>{this.health.down()}),600),setInterval((()=>{this.health.max()}),5e3)}}function xt(t){return{pos:yt(..._t(t))}}function yt(t,e){let r=c(t,{equals:!1}),n=c(e,{equals:!1}),i=f((()=>ft(dt(r),dt(n))));return{get point(){return i()},m_vs:f((()=>G.make(..._t(i())))),get x(){return dt(r)},set x(t){ht(r,t)},get y(){return dt(n)},set y(t){ht(n,t)}}}function wt(t,e,r){let n,[{update:i}]=ut(),s=c(0),o=f((()=>dt(s)/e)),l=f(I(i,(([t,e])=>(n?.()??0)*r*t/e+o()*t*(t+e)/2))),a=f((t=>t+l()),t);return n=f(I(a,((e,r)=>e-(r??t)))),{get x(){return a()},get vx(){return l()},set force(t){ht(s,t)},get debug(){return[dt(s),n()]}}}function bt(t){let e=St(st.thirds,12336731,16777215);return{frame:t,get tint(){return e()}}}function Et(){let[{update:t}]=ut();return f((e=>{let[r,n]=t();return e+r}),0)}function Tt(t){let e=f(I(Et(),((e,r)=>Math.floor(r/t)!==Math.floor(e/t))));return f((t=>e()?t:t+1),0)}function Rt(t){let e=I(Et(),(e=>e<=t));return f(I(e,((t,e,r)=>t!==e?t?r+1:-1:t?r+1:r)),0)}function St(t,e=!0,r=!1){return f(I(Et(),(n=>n<=t?e:r)))}const Mt=t=>t<.5?2*t*t:(4-2*t)*t-1;function Ut(t){let e=[...Array(t).keys()].map((t=>"!")).join("");return[...Array(10-t).keys()].map((t=>".")).join("")+e}function kt(t,e){let r=c(t,{equals:!1}),n=f($(r[0],e));return{get values(){return n()},get head(){return n()[0]},push(t){ct(r,(e=>e.push(t)))},enqueue(t){ct(r,(e=>e.unshift(t)))},dequeue(){let t;return ct(r,(e=>t=e.shift())),t},remove(t){ct(r,(e=>e.splice(e.indexOf(t),1)))},clear(){ht(r,[])}}}const Pt=10;const It=J(),Dt=t=>[L(Lt,{}),L(jt,{x:10,y:40,get children(){return L(jt,{x:1,y:1,scale:2,get children(){return L(Bt,{get letters(){return t.game.status.m_status()}})}})}}),L($t,{get player(){return t.game.player}}),L(Ft,{get cursor(){return t.game.cursor}}),L(B,{get each(){return t.game.enemies},children:t=>L(jt,{get x(){return t.pos.x},get y(){return t.pos.y},get children(){return L(Ct,{lum:1,get color(){return t.tint},w:8,h:8})}})}),L(jt,{x:2,y:2,get children(){return[L(Ct,{color:4,w:30,h:9}),L(jt,{x:1,y:1,get children(){return L(Bt,{get letters(){return t.game.level.m_level()}})}})]}}),L(jt,{x:200,y:2,get children(){return[L(Ct,{color:4,w:30,h:9}),L(jt,{x:1,y:1,get children(){return L(Bt,{get letters(){return t.game.health.m_health()}})}})]}}),L(B,{get each(){return t.game.player.waypoints},children:t=>L(jt,{get x(){return t.pos.x},get y(){return t.pos.y},get children(){return L(Ct,{lum:0,color:0,w:2,h:2})}})}),L(B,{get each(){return t.game.projectiles},children:t=>L(jt,{get x(){return t.pos.x},get y(){return t.pos.y},get children(){return L(Ct,{lum:2,color:3,w:2,h:2})}})})],Ft=t=>L(jt,{get x(){return t.cursor.pos.x},get y(){return t.cursor.pos.y},get children(){return[L(Ct,{lum:0,x:-2,y:-2,w:2,h:2}),L(Ct,{lum:0,w:4,h:6})]}}),$t=t=>L(jt,{get x(){return t.player.pos.x},get y(){return t.player.pos.y},get children(){return L(Ct,{color:6,w:10,h:10})}}),Lt=()=>L(Ct,{x:0,y:0,w:320,h:180}),Bt=t=>L(B,{get each(){return t.letters},children:(t,e)=>L(jt,{get x(){return 4*e()},y:0,get children(){return L(qt,{get tint(){return t.tint},get qs(){return[16+8*t.frame,16,8,7]}})}})}),Ct=t=>L(qt,{get qs(){return[0+2*(t.lum??2),0+2*(t.color??0),1,1]},get size(){return G.make(t.w,t.h)},get x(){return t.x},get y(){return t.y}}),jt=t=>(()=>{const e=It.clone;return K(e,(()=>t.children)),d((r=>{const n=t.tint,i=t.x,s=t.y,o=G.make(t.scale||1,t.scale||1);return n!==r._v$&&Z(e,"tint",r._v$=n),i!==r._v$2&&Z(e,"x",r._v$2=i),s!==r._v$3&&Z(e,"y",r._v$3=s),o!==r._v$4&&Z(e,"scale",r._v$4=o),r}),{_v$:void 0,_v$2:void 0,_v$3:void 0,_v$4:void 0}),e})(),qt=t=>{let[{image:e}]=ut();return(()=>{const r=It.clone;return d((n=>{const i=W.make(e(),...t.qs),s=t.size||G.make(t.qs[2],t.qs[3]),o=t.tint,l=t.x,a=t.y;return i!==n._v$5&&Z(r,"quad",n._v$5=i),s!==n._v$6&&Z(r,"size",n._v$6=s),o!==n._v$7&&Z(r,"tint",n._v$7=o),l!==n._v$8&&Z(r,"x",n._v$8=l),a!==n._v$9&&Z(r,"y",n._v$9=a),n}),{_v$5:void 0,_v$6:void 0,_v$7:void 0,_v$8:void 0,_v$9:void 0}),r})()};function Nt(t){return(e="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAEACAMAAADyTj5VAAAAAXNSR0IArs4c6QAAAFdQTFRFAAAAAAAAACAzBExME3BWGiFcIxZbIycxMZ9yMlaQQCRxQqI9SAg2TbDIcH6Aes5KfrrOjk2unFtQqGZjvD5byP/S3aXn4f+N8JaM8Luc/825/+G8////fcUbnAAAAAF0Uk5TAEDm2GYAAAIJSURBVHja7ddJdoMwDABQq/M8z/X9z9lFXygYm5Au8f8bP3AiiC0JknK+uzs/j0j0SQJ07vX14uLk5PjYSkgAevT+fn9/fX10ZCUkAD36/v78fH5+erISEoAefX19fLy83NxYCQlAj97eHh+vrs7OrIQEoEcPD7e3l5enp1ZCAgDQu4iIGI1pdLxvfs84i58q30/FdQ6IXx1T5b7TP+93EnezCZBzjvEYw3HE4nzk6vxwPsr4UcTfxYvG9ct4e8bfz+8uPL5uWrzP3LrfadztJsBsQaNxHNX5GDY2lhNg7UZGK97yGFEkwN/9pdH8MLZ+X9Tj99ABYrpxUVbQbmGjVnGjymvEiVblVTvObCNnGz7rHFH7XtkRUuRG58qTHzI7v9UnwSEdIC1txHzDYlWl56LSW5XcauExjTe8A8wSpajwRkf4S4DycxvNg9kCNyuk1dLLZ23seYYXHSLqnWBIgGi8K+RWpbae+SsrvTg/SohJw+viX8Ahb8kHvG1PK6kxn4p/DWll/NWfS+vOj47Tlp8EAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMDBfgDTIjE37oSU2AAAAABJRU5ErkJggg==",new Promise((t=>{let r=new Image;r.onload=()=>t(r),r.src=e}))).then((e=>{let[r,n,i]=((t,e,r,n)=>{let i=new C(t,r,n),s=new Q(i);s.glOnce(),s.glClear();let o=new X,l=256e3,{program:a,uniformData:u,indexBuffer:h,attributeBuffer:c,vao:d}=s.glProgram("#version 300 es\nin vec3 aTint;\nin vec2 aVertexPosition;\nin vec2 aTextureCoord;\n\nuniform mat3 projectionMatrix;\n\nout vec2 vTextureCoord;\nout vec3 vTint;\n\nvoid main() {\n  gl_Position = vec4((projectionMatrix * vec3(aVertexPosition, 1.0)).xy, 0, 1);\n\n  vTextureCoord = aTextureCoord;\n  vTint = aTint;\n}\n","#version 300 es\nprecision highp float;\n\nin vec3 aTint;\nin vec2 vTextureCoord;\nin vec3 vTint;\nout vec4 outColor;\n\nuniform sampler2D uSampler;\n\nvoid main() {\n  //outColor = vec4(1.0, 1.0, 0.0, 1.0);\n  vec4 color = texture(uSampler, vTextureCoord);\n  color.rgb *= vTint;\n  outColor = vec4(color.rgb * color.a, color.a);\n}\n\n",l),g=new Uint16Array(3*l),f=new Float32Array(6*l),{glTexture:_}=s.glTexture();return s.glUseTexture(_,e),[(t,e)=>{s.glClear(),s.glUse(a,u);let r=0,n=0,i=0;for(let t=0;t<o._flat.length;t++){let e=o._flat[t],{world:s,quad:l,tint:a}=e;if(!l)continue;let{vertexData:u,indices:h}=Y.unit.transform(s),{texture:c,fsUv:d}=l,_=H(a);for(let t=0;t<u.length;t+=2)f[r++]=u[t],f[r++]=u[t+1],f[r++]=d[t],f[r++]=d[t+1],f[r++]=_[0],f[r++]=_[1],f[r++]=_[2];for(let t=0;t<h.length;t++)g[n++]=4*i+h[t];i++}let l=!1;for(let t=o._flat.length-1;t>=0;t--){let e=o._flat[t];l||=e.on_event?.()}s.glAttribUpdate(c,f),s.glIndexUpdate(h,g),s.glDraw(6*i,d)},o,i.$canvas]})(t,e,320,180);!function(t,e,r){let n;h((i=>{n=i,K(e,t(),void 0,r)}))}(((t,e,r,n)=>{let i=()=>{const[{image:n,root:i,update:s,render:o,mouse:l},{_setImage:a,_setRoot:u}]=ut();a(e),u(r),g(I(o,(()=>{i()._update_world(),t()})));let h=new mt;return L(Dt,{game:h})};return()=>L(at,{$canvas:n,get children(){return L(i,{})}})})(r,e,n,i),n)}));var e}return function(t){Nt(t)}}();
